name: Process
on:
  schedule:
    - cron: "05 03 * * *"
    - cron: "05 11 * * *"
  workflow_dispatch:

env:
  # time zone
  TZ: Asia/Shanghai

  # network proxy aggregate config
  SUBSCRIBE_CONF: ${{ secrets.SUBSCRIBE_CONF }}

  # token
  PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}

  # My Gist credentials
  MY_GIST_USERNAME: ${{ secrets.MY_GIST_USERNAME }}
  MY_GIST_ID: ${{ secrets.MY_GIST_ID }}

  # network reachable
  REACHABLE: ${{ vars.REACHABLE }}

  # not check connective
  SKIP_ALIVE_CHECK: ${{ vars.SKIP_ALIVE_CHECK }}

  # skip remark
  SKIP_REMARK: ${{ vars.SKIP_REMARK }}

  # workflow mode
  WORKFLOW_MODE: ${{ vars.WORKFLOW_MODE }}

  # include spwcial protocols, such vless hysteria2 and hysteria
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: pip3 install -r requirements.txt

      - name: Replace Secrets in All Config Files
        run: |
          echo "üîê Replacing secrets in all JSON config files..."
          python3 << 'EOF'
          import os
          import glob
          
          gist_username = os.environ.get('MY_GIST_USERNAME')
          gist_id = os.environ.get('MY_GIST_ID')
          
          if not gist_username or not gist_id:
              print("‚ùå Error: Environment variables not found")
              print(f"MY_GIST_USERNAME: {gist_username}")
              print(f"MY_GIST_ID: {gist_id}")
              exit(1)
          
          print(f"‚úì Username: {gist_username}")
          print(f"‚úì Gist ID: {gist_id[:8]}...{gist_id[-8:]}")
          print()
          
          # Êü•ÊâæÊâÄÊúâ JSON ÈÖçÁΩÆÊñá‰ª∂
          json_files = glob.glob('**/*.json', recursive=True)
          print(f"Found {len(json_files)} JSON files:")
          for f in json_files:
              print(f"  - {f}")
          print()
          
          replaced_files = 0
          total_replacements = 0
          
          for json_file in json_files:
              try:
                  with open(json_file, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Âç†‰ΩçÁ¨¶
                  username_count = content.count('{{MY_GIST_USERNAME}}')
                  id_count = content.count('{{MY_GIST_ID}}')
                  
                  if username_count > 0 or id_count > 0:
                      print(f"üìù Processing: {json_file}")
                      print(f"   Found {username_count} username placeholders")
                      print(f"   Found {id_count} gist ID placeholders")
                      
                      # ÊõøÊç¢Âç†‰ΩçÁ¨¶
                      content = content.replace('{{MY_GIST_USERNAME}}', gist_username)
                      content = content.replace('{{MY_GIST_ID}}', gist_id)
                      
                      # ÂÜôÂõûÊñá‰ª∂
                      with open(json_file, 'w', encoding='utf-8') as f:
                          f.write(content)
                      
                      # È™åËØÅÊõøÊç¢
                      with open(json_file, 'r', encoding='utf-8') as f:
                          verify_content = f.read()
                      
                      remaining_username = verify_content.count('{{MY_GIST_USERNAME}}')
                      remaining_id = verify_content.count('{{MY_GIST_ID}}')
                      
                      if remaining_username > 0 or remaining_id > 0:
                          print(f"   ‚ùå Failed: {remaining_username + remaining_id} placeholders remaining")
                          exit(1)
                      else:
                          print(f"   ‚úÖ Success: All placeholders replaced")
                          replaced_files += 1
                          total_replacements += username_count + id_count
                      print()
              
              except Exception as e:
                  print(f"   ‚ö†Ô∏è  Error processing {json_file}: {e}")
                  print()
          
          print(f"üìä Summary:")
          print(f"   Files processed: {replaced_files}")
          print(f"   Total replacements: {total_replacements}")
          
          if replaced_files == 0:
              print("‚ö†Ô∏è  Warning: No files were modified. Check if placeholders exist in config files.")
          else:
              print("‚úÖ All secrets replaced successfully!")
          EOF
        env:
          MY_GIST_USERNAME: ${{ secrets.MY_GIST_USERNAME }}
          MY_GIST_ID: ${{ secrets.MY_GIST_ID }}

      - name: Verify Config Before Process
        run: |
          echo "üîç Verifying configuration file..."
          if grep -r "{{MY_GIST" subscribe/config/my-process.json; then
            echo "‚ùå ERROR: Placeholders still exist in config file!"
            cat subscribe/config/my-process.json
            exit 1
          else
            echo "‚úÖ No placeholders found - config is ready"
          fi

      - name: Process
        run: python -u subscribe/process.py -s subscribe/config/my-process.json --overwrite

      - name: Fix YAML Format
        run: |
          echo "üîß Fixing YAML format issues..."
          
          # Êü•ÊâæÊâÄÊúâÁîüÊàêÁöÑ YAML Êñá‰ª∂
          file_count=0
          fixed_count=0
          
          for file in $(find . -type f \( -name "*.yaml" -o -name "*.yml" \)); do
            file_count=$((file_count + 1))
            echo "üìÑ Processing: $file"
            
            # Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶ÂåÖÂê´ÈóÆÈ¢òÊ†ºÂºè
            if grep -q "!<str>\|!<int>\|!<bool>\|!<float>" "$file"; then
              # ‰øÆÂ§çÂêÑÁßç YAML Á±ªÂûãÊ†áÁ≠æ
              sed -i 's/: !<str> /: /g' "$file"
              sed -i 's/: !<int> /: /g' "$file"
              sed -i 's/: !<bool> /: /g' "$file"
              sed -i 's/: !<float> /: /g' "$file"
              fixed_count=$((fixed_count + 1))
              echo "‚úÖ Fixed: $file"
            else
              echo "‚úì No issues found: $file"
            fi
          done
          
          echo ""
          echo "üìä Summary:"
          echo "   Total files processed: $file_count"
          echo "   Files fixed: $fixed_count"
          echo "‚ú® Format fix completed!"

      - name: Timestamp
        run: date
