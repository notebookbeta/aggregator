name: Process
on:
  schedule:
    - cron: "05 03 * * *"
    - cron: "05 11 * * *"
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  SUBSCRIBE_CONF: ${{ secrets.SUBSCRIBE_CONF }}
  PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
  MY_GIST_USERNAME: ${{ secrets.MY_GIST_USERNAME }}
  MY_GIST_ID: ${{ secrets.MY_GIST_ID }}
  REACHABLE: ${{ vars.REACHABLE }}
  SKIP_ALIVE_CHECK: ${{ vars.SKIP_ALIVE_CHECK }}
  SKIP_REMARK: ${{ vars.SKIP_REMARK }}
  WORKFLOW_MODE: ${{ vars.WORKFLOW_MODE }}
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: pip3 install -r requirements.txt

      - name: Replace Secrets in Config
        run: |
          echo "üîê Replacing secrets in configuration..."
          
          if [ -z "$MY_GIST_USERNAME" ] || [ -z "$MY_GIST_ID" ]; then
            echo "‚ùå ERROR: Secrets not found!"
            exit 1
          fi
          
          echo "‚úì Username: $MY_GIST_USERNAME"
          echo "‚úì Gist ID: ${MY_GIST_ID:0:8}...${MY_GIST_ID: -8}"
          
          # ÊõøÊç¢ÈÖçÁΩÆÊñá‰ª∂‰∏≠ÁöÑÂç†‰ΩçÁ¨¶
          find . -type f -name "*.json" -exec grep -l "{{MY_GIST" {} \; | while read file; do
            echo "üìù Processing: $file"
            sed -i "s/{{MY_GIST_USERNAME}}/$MY_GIST_USERNAME/g" "$file"
            sed -i "s/{{MY_GIST_ID}}/$MY_GIST_ID/g" "$file"
          done
          
          # È™åËØÅÊõøÊç¢ÁªìÊûú
          echo ""
          if grep -r "{{MY_GIST" . --include="*.json" 2>/dev/null; then
            echo "‚ùå ERROR: Placeholders still exist!"
            exit 1
          fi
          echo "‚úÖ All placeholders replaced successfully!"

      - name: Process
        run: python -u subscribe/process.py -s subscribe/config/my-process.json --overwrite

      - name: Fix YAML Format
        run: |
          echo "üîß Fixing YAML format issues..."
          
          file_count=0
          fixed_count=0
          
          for file in $(find . -type f \( -name "*.yaml" -o -name "*.yml" \)); do
            file_count=$((file_count + 1))
            
            if grep -q "!<str>\|!<int>\|!<bool>\|!<float>" "$file"; then
              sed -i 's/: !<str> /: /g' "$file"
              sed -i 's/: !<int> /: /g' "$file"
              sed -i 's/: !<bool> /: /g' "$file"
              sed -i 's/: !<float> /: /g' "$file"
              fixed_count=$((fixed_count + 1))
              echo "‚úÖ Fixed: $file"
            fi
          done
          
          echo "üìä Total: $file_count files, Fixed: $fixed_count files"

      - name: Timestamp
        run: date
