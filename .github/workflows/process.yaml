name: Process
on:
  schedule:
    - cron: "05 03 * * *"
    - cron: "05 11 * * *"
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  SUBSCRIBE_CONF: ${{ secrets.SUBSCRIBE_CONF }}
  PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
  MY_GIST_USERNAME: ${{ secrets.MY_GIST_USERNAME }}
  MY_GIST_ID: ${{ secrets.MY_GIST_ID }}
  REACHABLE: ${{ vars.REACHABLE }}
  SKIP_ALIVE_CHECK: ${{ vars.SKIP_ALIVE_CHECK }}
  SKIP_REMARK: ${{ vars.SKIP_REMARK }}
  WORKFLOW_MODE: ${{ vars.WORKFLOW_MODE }}
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: pip3 install -r requirements.txt

      - name: Replace Secrets in Config
        run: |
          echo "ğŸ” Replacing secrets in configuration..."
          
          if [ -z "$MY_GIST_USERNAME" ] || [ -z "$MY_GIST_ID" ]; then
            echo "âŒ ERROR: Secrets not found!"
            exit 1
          fi
          
          echo "âœ“ Username: $MY_GIST_USERNAME"
          echo "âœ“ Gist ID: ${MY_GIST_ID:0:8}...${MY_GIST_ID: -8}"
          
          find . -type f -name "*.json" -exec grep -l "{{MY_GIST" {} \; | while read file; do
            echo "ğŸ“ Processing: $file"
            sed -i "s/{{MY_GIST_USERNAME}}/$MY_GIST_USERNAME/g" "$file"
            sed -i "s/{{MY_GIST_ID}}/$MY_GIST_ID/g" "$file"
          done
          
          if grep -r "{{MY_GIST" . --include="*.json" 2>/dev/null; then
            echo "âŒ ERROR: Placeholders still exist!"
            exit 1
          fi
          echo "âœ… All placeholders replaced successfully!"

      - name: Create YAML Fix Wrapper
        run: |
          echo "ğŸ”§ Creating YAML format fix wrapper..."
          
          cat > fix_yaml_wrapper.py << 'EOFPYTHON'
          #!/usr/bin/env python3
          """
          Wrapper script that monkey-patches YAML dump to fix type tags
          """
          import sys
          import re
          
          # Monkey patch yaml.dump before any imports
          def patch_yaml():
              try:
                  import yaml
                  original_dump = yaml.dump
                  
                  def fixed_dump(*args, **kwargs):
                      result = original_dump(*args, **kwargs)
                      if isinstance(result, str):
                          # Remove YAML type tags
                          result = re.sub(r': !<str> ', ': ', result)
                          result = re.sub(r': !<int> ', ': ', result)
                          result = re.sub(r': !<bool> ', ': ', result)
                          result = re.sub(r': !<float> ', ': ', result)
                      return result
                  
                  yaml.dump = fixed_dump
                  print("âœ“ YAML dump patched successfully", file=sys.stderr)
              except ImportError:
                  print("âš  yaml module not found, skipping patch", file=sys.stderr)
              
              try:
                  import ruamel.yaml
                  # Patch ruamel.yaml if used
                  print("âœ“ Found ruamel.yaml", file=sys.stderr)
              except ImportError:
                  pass
          
          # Apply patch
          patch_yaml()
          
          # Now run the original script
          if __name__ == '__main__':
              import subprocess
              # Pass all arguments to the original process.py
              result = subprocess.run([sys.executable, '-u', 'subscribe/process.py'] + sys.argv[1:])
              sys.exit(result.returncode)
          EOFPYTHON
          
          chmod +x fix_yaml_wrapper.py
          echo "âœ… Wrapper created"

      - name: Process
        run: python fix_yaml_wrapper.py -s subscribe/config/my-process.json --overwrite

      - name: Fix YAML Format in Generated Files
        run: |
          echo "ğŸ”§ Fixing YAML format in all generated files..."
          
          file_count=0
          fixed_count=0
          
          # æŸ¥æ‰¾æ‰€æœ‰ç”Ÿæˆçš„ YAML æ–‡ä»¶
          for file in $(find . -type f \( -name "*.yaml" -o -name "*.yml" \) ! -path "./.git/*"); do
            file_count=$((file_count + 1))
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«é—®é¢˜æ ¼å¼
            if grep -q "!<str>\|!<int>\|!<bool>\|!<float>" "$file" 2>/dev/null; then
              echo "ğŸ“ Fixing: $file"
              
              # ä¿®å¤æ ¼å¼
              sed -i 's/: !<str> /: /g' "$file"
              sed -i 's/: !<int> /: /g' "$file"
              sed -i 's/: !<bool> /: /g' "$file"
              sed -i 's/: !<float> /: /g' "$file"
              
              fixed_count=$((fixed_count + 1))
              
              # æ˜¾ç¤ºä¿®å¤åçš„ç¤ºä¾‹
              echo "  Sample after fix:"
              grep "password:\|port:\|alterId:" "$file" | head -2
            fi
          done
          
          echo ""
          echo "ğŸ“Š Summary:"
          echo "   Total YAML files: $file_count"
          echo "   Files fixed: $fixed_count"
          
          if [ $fixed_count -gt 0 ]; then
            echo "âœ… Fixed $fixed_count file(s)"
          else
            echo "âœ“ No files needed fixing"
          fi

      - name: Re-upload Fixed Files to Gist
        run: |
          echo "ğŸ“¤ Re-uploading fixed YAML files to Gist..."
          
          # å®‰è£…ä¾èµ–
          pip install -q requests
          
          python3 << 'EOFPYTHON'
          import os
          import json
          import requests
          from pathlib import Path
          
          # ä»ç¯å¢ƒå˜é‡è·å–é…ç½®
          gist_id = os.environ.get('MY_GIST_ID')
          token = os.environ.get('PUSH_TOKEN')
          
          if not gist_id or not token:
              print("âŒ Missing GIST_ID or PUSH_TOKEN")
              exit(1)
          
          print(f"âœ“ Gist ID: {gist_id[:8]}...{gist_id[-8:]}")
          
          # è¯»å–é…ç½®æ–‡ä»¶æ‰¾åˆ°éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶
          config_path = 'subscribe/config/my-process.json'
          with open(config_path, 'r') as f:
              config = json.load(f)
          
          storage_items = config.get('storage', {}).get('items', {})
          
          # å‡†å¤‡è¦æ›´æ–°çš„æ–‡ä»¶
          files_to_update = {}
          
          for item_name, item_config in storage_items.items():
              filename = item_config.get('filename', '')
              
              # åªå¤„ç† YAML æ–‡ä»¶
              if not (filename.endswith('.yaml') or filename.endswith('.yml')):
                  continue
              
              # æŸ¥æ‰¾å¯¹åº”çš„æœ¬åœ°æ–‡ä»¶
              possible_paths = [
                  filename,
                  f'./{filename}',
                  f'subscribe/{filename}',
                  f'subscribe/output/{filename}',
              ]
              
              file_path = None
              for path in possible_paths:
                  if Path(path).exists():
                      file_path = path
                      break
              
              if not file_path:
                  print(f"âš ï¸  File not found: {filename}")
                  continue
              
              # è¯»å–æ–‡ä»¶å†…å®¹
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # éªŒè¯æ˜¯å¦å·²ä¿®å¤
              if '!<str>' in content or '!<int>' in content:
                  print(f"âš ï¸  {filename} still has type tags!")
              else:
                  print(f"âœ“ {filename} format is correct")
              
              files_to_update[filename] = {"content": content}
          
          if not files_to_update:
              print("âš ï¸  No YAML files found to update")
              exit(0)
          
          # æ›´æ–° Gist
          print(f"\nğŸ“¤ Uploading {len(files_to_update)} file(s) to Gist...")
          
          url = f"https://api.github.com/gists/{gist_id}"
          headers = {
              "Authorization": f"token {token}",
              "Accept": "application/vnd.github.v3+json"
          }
          data = {"files": files_to_update}
          
          response = requests.patch(url, headers=headers, json=data)
          
          if response.status_code == 200:
              print("âœ… Successfully updated Gist!")
              for filename in files_to_update.keys():
                  print(f"   âœ“ {filename}")
          else:
              print(f"âŒ Failed to update Gist: {response.status_code}")
              print(response.text)
              exit(1)
          EOFPYTHON

      - name: Timestamp
        run: date
