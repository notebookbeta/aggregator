name: Process
on:
  schedule:
    - cron: "05 03 * * *"
    - cron: "05 11 * * *"
  workflow_dispatch:

env:
  # time zone
  TZ: Asia/Shanghai

  # network proxy aggregate config
  SUBSCRIBE_CONF: ${{ secrets.SUBSCRIBE_CONF }}

  # token
  PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}

  # network reachable
  REACHABLE: ${{ vars.REACHABLE }}

  # not check connective
  SKIP_ALIVE_CHECK: ${{ vars.SKIP_ALIVE_CHECK }}

  # skip remark
  SKIP_REMARK: ${{ vars.SKIP_REMARK }}

  # workflow mode
  WORKFLOW_MODE: ${{ vars.WORKFLOW_MODE }}

  # include spwcial protocols, such vless hysteria2 and hysteria
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: pip3 install -r requirements.txt

      - name: Process
        run: python -u subscribe/process.py -s subscribe/config/my-process.json --overwrite

# ⭐ 自动清洗 Gist 里的 sub1-clash.yaml，把 password: !<str> 123456 变成 "123456"
      - name: Fix Clash YAML passwords
        run: |
          GIST_ID="YOUR_GIST_ID"
          USERNAME="YOUR_USERNAME"

          RAW_URL="https://gist.githubusercontent.com/${USERNAME}/${GIST_ID}/raw/sub1-clash.yaml"

          echo "Downloading sub1-clash.yaml..."
          curl -L "$RAW_URL" -o sub1-clash.yaml

          echo "Before fix (first 10 lines):"
          head -n 10 sub1-clash.yaml || true

          echo "Cleaning YAML..."
          sed -E 's/password: !<str> ([0-9]+)/password: "\1"/g' sub1-clash.yaml > sub1-clash-clean.yaml

          echo "After fix (first 10 lines):"
          head -n 10 sub1-clash-clean.yaml || true

          echo "Uploading cleaned YAML back to Gist with Python..."
          python - << 'PY'
import os, json, urllib.request

gist_id = os.environ["GIST_ID"]
token = os.environ["PUSH_TOKEN"]

with open("sub1-clash-clean.yaml", "r", encoding="utf-8") as f:
    content = f.read()

data = json.dumps({
    "files": {
        "sub1-clash.yaml": {
            "content": content
        }
    }
}).encode("utf-8")

req = urllib.request.Request(
    f"https://api.github.com/gists/{gist_id}",
    data=data,
    headers={
        "Authorization": f"token {token}",
        "Content-Type": "application/json",
        "Accept": "application/vnd.github+json",
    },
    method="PATCH",
)

with urllib.request.urlopen(req) as resp:
    print("Gist update status:", resp.status)
PY

      - name: Timestamp
        run: date
