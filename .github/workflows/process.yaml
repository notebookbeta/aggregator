name: Process
on:
  schedule:
    - cron: "05 03 * * *"
    - cron: "05 11 * * *"
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  SUBSCRIBE_CONF: ${{ secrets.SUBSCRIBE_CONF }}
  PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
  REACHABLE: ${{ vars.REACHABLE }}
  SKIP_ALIVE_CHECK: ${{ vars.SKIP_ALIVE_CHECK }}
  SKIP_REMARK: ${{ vars.SKIP_REMARK }}
  WORKFLOW_MODE: ${{ vars.WORKFLOW_MODE }}
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: pip3 install -r requirements.txt

      - name: Debug - Show all JSON files
        run: |
          echo "ğŸ” Searching for all JSON config files..."
          find . -name "*.json" -type f | while read file; do
            echo "Found: $file"
            if grep -l "GIST" "$file" 2>/dev/null; then
              echo "  Contains GIST references"
            fi
          done

      - name: Replace Secrets Everywhere
        run: |
          echo "ğŸ” Aggressively replacing secrets in ALL files..."
          
          GIST_USERNAME="${{ secrets.MY_GIST_USERNAME }}"
          GIST_ID="${{ secrets.MY_GIST_ID }}"
          
          if [ -z "$GIST_USERNAME" ] || [ -z "$GIST_ID" ]; then
            echo "âŒ ERROR: Secrets not found!"
            echo "GIST_USERNAME: $GIST_USERNAME"
            echo "GIST_ID: ${GIST_ID:0:8}...${GIST_ID: -8}"
            exit 1
          fi
          
          echo "âœ“ Username: $GIST_USERNAME"
          echo "âœ“ Gist ID: ${GIST_ID:0:8}...${GIST_ID: -8}"
          
          # æ›¿æ¢æ‰€æœ‰åŒ…å«å ä½ç¬¦çš„æ–‡ä»¶
          find . -type f \( -name "*.json" -o -name "*.py" -o -name "*.yaml" -o -name "*.yml" \) -exec grep -l "{{MY_GIST" {} \; | while read file; do
            echo "ğŸ“ Replacing in: $file"
            sed -i "s/{{MY_GIST_USERNAME}}/$GIST_USERNAME/g" "$file"
            sed -i "s/{{MY_GIST_ID}}/$GIST_ID/g" "$file"
          done
          
          # æ˜¾ç¤ºæ›¿æ¢å my-process.json çš„å†…å®¹ï¼ˆéƒ¨åˆ†ï¼‰
          echo ""
          echo "ğŸ“„ Config file after replacement:"
          if [ -f "subscribe/config/my-process.json" ]; then
            grep -A2 -B2 "gistid" subscribe/config/my-process.json | head -20
          fi
          
          # æœ€ç»ˆéªŒè¯
          echo ""
          echo "ğŸ” Checking for remaining placeholders..."
          if find . -type f -name "*.json" -exec grep -H "{{MY_GIST" {} \;; then
            echo "âŒ ERROR: Placeholders still exist!"
            exit 1
          else
            echo "âœ… All placeholders replaced!"
          fi

      - name: Process
        run: python -u subscribe/process.py -s subscribe/config/my-process.json --overwrite

      - name: Fix YAML Format
        run: |
          echo "ğŸ”§ Fixing YAML format issues..."
          
          file_count=0
          fixed_count=0
          
          for file in $(find . -type f \( -name "*.yaml" -o -name "*.yml" \)); do
            file_count=$((file_count + 1))
            echo "ğŸ“„ Processing: $file"
            
            if grep -q "!<str>\|!<int>\|!<bool>\|!<float>" "$file"; then
              sed -i 's/: !<str> /: /g' "$file"
              sed -i 's/: !<int> /: /g' "$file"
              sed -i 's/: !<bool> /: /g' "$file"
              sed -i 's/: !<float> /: /g' "$file"
              fixed_count=$((fixed_count + 1))
              echo "âœ… Fixed: $file"
            else
              echo "âœ“ No issues found: $file"
            fi
          done
          
          echo ""
          echo "ğŸ“Š Summary:"
          echo "   Total files processed: $file_count"
          echo "   Files fixed: $fixed_count"
          echo "âœ¨ Format fix completed!"

      - name: Timestamp
        run: date
