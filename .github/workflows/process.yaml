name: Process
on:
  schedule:
    - cron: "05 03 * * *"
    - cron: "05 11 * * *"
  workflow_dispatch:

env:
  # time zone
  TZ: Asia/Shanghai

  # network proxy aggregate config
  SUBSCRIBE_CONF: ${{ secrets.SUBSCRIBE_CONF }}

  # token
  PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}

  # My Gist credentials
  MY_GIST_USERNAME: ${{ secrets.MY_GIST_USERNAME }}
  MY_GIST_ID: ${{ secrets.MY_GIST_ID }}

  # network reachable
  REACHABLE: ${{ vars.REACHABLE }}

  # not check connective
  SKIP_ALIVE_CHECK: ${{ vars.SKIP_ALIVE_CHECK }}

  # skip remark
  SKIP_REMARK: ${{ vars.SKIP_REMARK }}

  # workflow mode
  WORKFLOW_MODE: ${{ vars.WORKFLOW_MODE }}

  # include spwcial protocols, such vless hysteria2 and hysteria
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: pip3 install -r requirements.txt

      - name: Replace Secrets in Config
        run: |
          echo "ğŸ” Replacing secrets in config file with Python..."
          python3 << 'EOF'
          import json
          import os
          
          config_path = 'subscribe/config/my-process.json'
          gist_username = os.environ.get('MY_GIST_USERNAME')
          gist_id = os.environ.get('MY_GIST_ID')
          
          if not gist_username or not gist_id:
              print("âŒ Error: Environment variables not found")
              exit(1)
          
          print(f"âœ“ Loading config from: {config_path}")
          print(f"âœ“ Username: {gist_username}")
          print(f"âœ“ Gist ID: {gist_id[:8]}...{gist_id[-8:]}")
          
          # è¯»å–é…ç½®æ–‡ä»¶
          with open(config_path, 'r', encoding='utf-8') as f:
              content = f.read()
          
          # æ£€æŸ¥å ä½ç¬¦
          placeholder_count = content.count('{{MY_GIST_USERNAME}}') + content.count('{{MY_GIST_ID}}')
          print(f"âœ“ Found {placeholder_count} placeholders to replace")
          
          # æ›¿æ¢å ä½ç¬¦
          content = content.replace('{{MY_GIST_USERNAME}}', gist_username)
          content = content.replace('{{MY_GIST_ID}}', gist_id)
          
          # å†™å›æ–‡ä»¶
          with open(config_path, 'w', encoding='utf-8') as f:
              f.write(content)
          
          # éªŒè¯æ›¿æ¢
          remaining = content.count('{{MY_GIST_USERNAME}}') + content.count('{{MY_GIST_ID}}')
          if remaining > 0:
              print(f"âŒ Warning: {remaining} placeholders were not replaced!")
              exit(1)
          
          # éªŒè¯ JSON æ ¼å¼
          with open(config_path, 'r', encoding='utf-8') as f:
              config = json.load(f)
          
          print("âœ… All placeholders replaced successfully")
          print("âœ… JSON format validated")
          print(f"âœ… Storage items configured: {len(config.get('storage', {}).get('items', {}))}")
          EOF
        env:
          MY_GIST_USERNAME: ${{ secrets.MY_GIST_USERNAME }}
          MY_GIST_ID: ${{ secrets.MY_GIST_ID }}

      - name: Process
        run: python -u subscribe/process.py -s subscribe/config/my-process.json --overwrite

      - name: Fix YAML Format
        run: |
          echo "ğŸ”§ Fixing YAML format issues..."
          
          # æŸ¥æ‰¾æ‰€æœ‰ç”Ÿæˆçš„ YAML æ–‡ä»¶
          file_count=0
          fixed_count=0
          
          for file in $(find . -type f \( -name "*.yaml" -o -name "*.yml" \)); do
            file_count=$((file_count + 1))
            echo "ğŸ“„ Processing: $file"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å«é—®é¢˜æ ¼å¼
            if grep -q "!<str>\|!<int>\|!<bool>\|!<float>" "$file"; then
              # ä¿®å¤å„ç§ YAML ç±»å‹æ ‡ç­¾
              sed -i 's/: !<str> /: /g' "$file"
              sed -i 's/: !<int> /: /g' "$file"
              sed -i 's/: !<bool> /: /g' "$file"
              sed -i 's/: !<float> /: /g' "$file"
              fixed_count=$((fixed_count + 1))
              echo "âœ… Fixed: $file"
            else
              echo "âœ“ No issues found: $file"
            fi
          done
          
          echo ""
          echo "ğŸ“Š Summary:"
          echo "   Total files processed: $file_count"
          echo "   Files fixed: $fixed_count"
          echo "âœ¨ Format fix completed!"

      - name: Timestamp
        run: date
