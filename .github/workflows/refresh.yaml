################################################################################
# 原 REFRESH.YAML 代码（已全部注释，仅作备份保留）
################################################################################

# name: Refresh
# on:
#   # performed every two hours
#   schedule:
#     - cron: "0 */2 * * *"
#   workflow_dispatch:
#
# concurrency:
#   group: ${{ github.repository }}
#   cancel-in-progress: true
#
# env:
#   # time zone
#   TZ: Asia/Shanghai
#
#   # github access token
#   GIST_PAT: ${{ secrets.GIST_PAT }}
#
#   # github username and gist id, separated by '/'
#   GIST_LINK: ${{ secrets.GIST_LINK }}
#
#   # the url to the list of airports that you maintain yourself
#   # each line include domain, coupon and invitation code, the domain must be included,
#   # and the latter two items are optional
#   CUSTOMIZE_LINK: ${{ secrets.CUSTOMIZE_LINK }}
#
#   # include special protocols, such as vless hysteria2 and hysteria
#   ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}
#
# jobs:
#   process:
#     runs-on: ubuntu-latest
#
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4
#         with:
#           ref: main
#
#       - name: Prepare
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.x"
#           architecture: "x64"
#           cache: "pip"
#
#       - name: Install
#         run: pip3 install -r requirements.txt
#
#       - name: Check
#         run: |
#           if [ -z "$GIST_PAT" ]; then
#               echo "Error: environment 'GIST_PAT' cannot be empty"
#               exit 1
#           fi
#
#           if [ -z "$GIST_LINK" ]; then
#               echo "Error: environment 'GIST_LINK' cannot be empty"
#               exit 1
#           fi
#
#           LINK_PARTS=$(echo "$GIST_LINK" | awk -F'/' 'NF==2 && $1!="" && $2!=""')
#           if [ -z "$LINK_PARTS" ]; then
#               echo "Error: environment 'GIST_LINK' is not valid, should be 'username/gist_id' format"
#               exit 1
#           fi
#
#       - name: Refresh
#         run: python -u subscribe/collect.py --all --refresh --overwrite --skip
#
#       - name: Timestamp
#         run: date


################################################################################
# 新 REFRESH.YAML（实际执行部分）
################################################################################

name: Refresh
on:
  # 1) Refresh：每两天一次，北京时间 05:15
  #    → UTC 前一天 21:15 → 15 21 */2 * *
  # 2) Collect：每周一次，北京时间 周日 23:45
  #    → UTC 周日 15:45 → 45 15 * * 0
  schedule:
    - cron: "15 21 */2 * *"  # every 2 days at 21:15 UTC (05:15 Asia/Shanghai)
    - cron: "45 15 * * 0"    # every Sunday at 15:45 UTC (23:45 Sunday Asia/Shanghai)
  workflow_dispatch:

concurrency:
  group: ${{ github.repository }}
  cancel-in-progress: true

env:
  # time zone (影响 date 命令的显示，但 cron 仍是 UTC)
  TZ: Asia/Shanghai

  # github access token
  GIST_PAT: ${{ secrets.GIST_PAT }}

  # github username and gist id, separated by '/'
  GIST_LINK: ${{ secrets.GIST_LINK }}

  # the url to the list of airports that you maintain yourself
  # each line include domain, coupon and invitation code, the domain must be included,
  # and the latter two items are optional
  CUSTOMIZE_LINK: ${{ secrets.CUSTOMIZE_LINK }}

  # include special protocols, such as vless hysteria2 and hysteria
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: pip3 install -r requirements.txt

      - name: Check env
        run: |
          if [ -z "$GIST_PAT" ]; then
              echo "Error: environment 'GIST_PAT' cannot be empty"
              exit 1
          fi

          if [ -z "$GIST_LINK" ]; then
              echo "Error: environment 'GIST_LINK' cannot be empty"
              exit 1
          fi

          LINK_PARTS=$(echo "$GIST_LINK" | awk -F'/' 'NF==2 && $1!="" && $2!=""')
          if [ -z "$LINK_PARTS" ]; then
              echo "Error: environment 'GIST_LINK' is not valid, should be 'username/gist_id' format"
              exit 1
          fi

      # 每周一次 Collect：
      # - 对于 schedule 事件，只在 cron == "45 15 * * 0" 时执行（也就是周日 23:45 北京时间）
      # - 对于手动触发（workflow_dispatch），也执行一次 Collect（方便你手动“洗池子”）
      - name: Weekly full collect (Sunday 23:45 Asia/Shanghai)
        if: github.event_name != 'schedule' || github.event.schedule == '45 15 * * 0'
        run: |
          echo "Current time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "Running full collect..."
          python -u subscribe/collect.py --all --overwrite --skip

      # Refresh：两天一次 05:15 + 周日 23:45 那次也顺便 refresh 一下
      #（也就是说：每次触发这个 workflow，都会跑一次 refresh）
      - name: Refresh (scheduled or manual)
        run: python -u subscribe/collect.py --all --refresh --overwrite --skip

      - name: Timestamp
        run: date "+%Y-%m-%d %H:%M:%S %Z"
